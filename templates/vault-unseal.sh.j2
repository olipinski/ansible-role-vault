#!/usr/bin/env sh

URL=https://127.0.0.1:8200
KEYS_FILE=/etc/vault/unseal.json

echo "Starting unsealer"
while true
do
    status=$(curl -s $URL/v1/sys/seal-status | jq '.sealed')
    if [ true = "$status" ]
    then
        echo "Unsealing"
        # Get keys from json file
        for i in `jq -r '.keys[]' $KEYS_FILE` 
          do curl -s --request PUT --data "{\"key\": \"$i\"}" $URL/v1/sys/unseal
        done
    fi
    sleep 10
done